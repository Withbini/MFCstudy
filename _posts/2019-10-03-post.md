---
title: "Cuda Video Decoder - Video Codec SDK 이용"
date: 2019-10-03
---

Video Codec SDK로의 버전 변경
===

Video Codec SDK 장점
---
원래 NVCUVID 디코더를 이용하다가 Video Codec SDK에 있는 NVDEC을 이용하기로 했다.
바꾼 이유는 NVDEC가 directx11 버전도 지원하고 있고 원래 있던
VideoSource -VideoParser -VideoDeocoder 과정에서 앞에 디먹싱하고 파싱하는 부분이 FFmpeg으로 대체되었다.
FFmpeg으로 대체되면서 장점은 내가 쓰기에 좀 더 간편해졌다는 것이고,  
directx11로 변환이 쉬워졌다.(코드를 잘 보고 분석만 하면 되므로)
뿐만 아니라 FFmpeg으로 가면서 오디오 디코딩도 원론적으로는 가능하다고 한다.
NVCUVID 이 쪽이 deprecated된 함수이므로 쓰지 말라는게 NVIDIA의 입장이었고, 바꾼 것은 좋은 선택이라고 본다.

그래서 실제로 바꾸었다.
MFC로 변환하는 과정을 거쳐 실제로 Video Codec SDK를 다이렉트9버전/다이렉트 11버전으로 해보았다.
근데 11버전에서 결과물이 깨지는 문제가 있었고 이를 해결하는 것이 필요하다.   
뿐만 아니라, 실제로 다이렉트11로 가면서 프레임 향상이 예상되었으나, 
그부분도 미흡한것으로 보인다.


Video Codec SDK 문제점 (NVCUVID와의 비교)
---
기존 것을 먼저 생각해보면 버튼을 누를경우 그 영상에 한해, 다이렉트 디바이스 초기화 및 쿠다 리소스 관련 초기화 하는 초기화 함수부분(initModule)을 실행하고 렌더링하는 부분을 스레드로 만들어주었다.

기존것의 문제는 다이렉트 디바이스를 너무 많이 생성하여서인지 CPU에서 이미 성능 제한이 걸렸다. 
그래서 Video SDK로 넘어갔는데, 여기서도 결국 스레드로 구현하였더니, 문제가 생겼다.

Video SDK에서는 FFmpeg 객체(디먹싱), Decode 객체(디코딩), Presenter 객체(프레젠트)를 만들고, 반복문을 돌며 디먹싱, 디코딩, RGBA 변환, 프레젠트를 한다.  
이 모든것이 한 함수(NVDecode 함수)안에 들어있고 이 함수를 스레드화하여 버튼을 누를때마다 스레드가 생성된다.  
여기서 첫 번째 문제는 Presenter 객체를 스레드로 생성하였다는 것이다. 사실 이걸 왜 스레드로 생성하였는지 이해는 안가는 부분이 많은데, 이부분을 먼저 그냥 일반 함수로 풀어주면,  
전체적인 스레드 수가 줄어들 것으로 예상된다.
두 번째 문제는 여전히 지난 버전에서 문제였던 FPS 제약이 SDK 버전에서도 존재한다는 것이다.  
심지어, RGBA변환을 SDK 버전에서는 쿠다로 하지 않는 것처럼 보여 눈으로 보기에 성능이 더 떨어진 것 같다.
(8채널의 경우 NVCUIVD 버전은 잘 돌아갔으나, 여기서는 버벅인다)

FPS 제한 문제를 해결하기 위한 방법-SwapChain
---
결국 다시 원점으로 돌아와서, Device를 여러개 생성하지 않는 방향을 고민해야할 것 같은데, 그것으로 제시할 수 있는 것은 SwapChain이다.  
백버퍼에 다른 채널의 프레임을 그려두고 다른 화면마다 뿌려줄 수 있다면 SwapChain이 큰 효과를 발휘할 것이다.
그전에 SwapChain에 대해 더 자세히 알 필요가 있을 것 같고 또 그전에 Cuda Context에 대해 더 이해할 필요가 있다.  
초기화한 contxt와 디먹싱 디코딩 프레젠테이션할 context가 같지 않으면 런타임 오류가 났었는데,   
context가 뭔지 좀 더 이해할 필요가 있다.

----

그!래!서! 이번주에 시도한 것은
* Context관련 버그 해결
    위에서도 언급했듯이, Context는 모두 같아야한다.
* Present 함수 사용법 익히기
    present함수는 해당 핸들에 특정 지역에만 그림을 그릴 수 있게 한다.(정확히는 특정 RECT에 그림을 교체해준다)
* DirectX11로 변환 시도
    DirectX9의 Present처럼 특정 RECT에만 그림을 그릴 수 있게 할 수 없는 것 같다.  
    이 부분을 좀 더 고민하든지, 스왑체인을 처리하던지 해야함
    게다가 DirectX11로 구현한 것은 디코딩이 꼬인 것처럼 화면에서 문제가 있다.
* 재생/정지 버튼 구현
* 프레임 조절(완벽하게 되지 않는다-쉬는 부분을 어떻게 처리할 지 )
